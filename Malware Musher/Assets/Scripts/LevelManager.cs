using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.UI;
using UnityEngine.Events;
using TMPro;

public class LevelManager : MonoBehaviour {

    [Header("GameObjects")]
    public GameObject enemyPrefab;

    [Header("UI Elements")]
    public Slider loadingSlider;

    [Header("Audio")]
    public AudioClip winSound;
    public AudioClip deathSound;
    private AudioSource audioSource;

    public delegate void DeathDelegate();
    public event DeathDelegate deathEvent;

    public delegate void WinDelegate();
    public event WinDelegate winEvent;

    public delegate void PauseDelegate();
    public event PauseDelegate pauseEvent;

    public delegate void UnPauseDelegate();
    public event UnPauseDelegate unPauseEvent;

    private bool hasDied = false;
    private bool hasWon = false;
    private bool hasPaused = false;
    private GameManager gameManager;
    private GameObject playerSpawn;
    private GameObject[] enemySpawn;
    private GameObject goalSpawn;

    public void Start() {
        audioSource = GetComponent<AudioSource>();
        gameManager = FindObjectOfType<GameManager>();
        Time.timeScale = 1f;

        playerSpawn = GameObject.FindGameObjectWithTag("PlayerSpawn");
        GameObject player = GameObject.FindGameObjectWithTag("Player");
        player.transform.position = playerSpawn.transform.position;
        GameObject.Destroy(playerSpawn);

        goalSpawn = GameObject.FindGameObjectWithTag("GoalSpawn");
        GameObject goal = GameObject.FindGameObjectWithTag("Goal");
        goal.transform.position = goalSpawn.transform.position;
        GameObject.Destroy(goalSpawn);
        goal.GetComponent<Goal>().goalTriggeredEvent += Win;

        enemySpawn = GameObject.FindGameObjectsWithTag("EnemySpawn");
        for (int i = 0; i < enemySpawn.Length; i++) {
            Instantiate(enemyPrefab, enemySpawn[i].transform.position, Quaternion.identity);
            GameObject.Destroy(enemySpawn[i]);
        }
    }

    public void Update() {
        /*if (Input.GetKeyDown(KeyCode.Escape)) {
            if (!hasDied && !hasWon) {
                if (!hasPaused) {
                    if (pauseEvent != null) {
                        pauseEvent();
                    }
                    pause.SetActive(true);
                    Time.timeScale = 0f;
                    hasPaused = true;
                } else {
                    if (unPauseEvent != null) {
                        unPauseEvent();
                    }
                    pause.SetActive(false);
                    Time.timeScale = 1f;
                    hasPaused = false;
                }
            }
        }*/
    }

    public void GameOver() {
        /*if (!hasDied) {
            if (deathEvent != null) {
                deathEvent();
            }
            gameManager.OnSceneDeath();
            audioSource.PlayOneShot(deathSound);
            gameOver.SetActive(true);
            Time.timeScale = 0f;
            hasDied = true;
        }*/
        gameManager.OnSceneDeath();
    }

    public void Win() {
        /*if (winEvent != null) {
            winEvent();
        }
        gameManager.OnSceneWin();
        audioSource.PlayOneShot(winSound);
        win.SetActive(true);
        Time.timeScale = 0f;*/
        gameManager.OnSceneWin();
    }
}
