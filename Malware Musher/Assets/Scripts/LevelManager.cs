using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.UI;
using UnityEngine.Events;
using TMPro;

public class LevelManager : MonoBehaviour {

    [Header("GameObjects")]
    public GameObject gameOver;
    public GameObject loadingBar;
    public GameObject win;
    public GameObject pause;
    public GameObject player;
    public GameObject enemyPrefab;
    public GameObject goal;

    [Header("UI Elements")]
    public Slider loadingSlider;

    [Header("Audio")]
    public AudioClip winSound;
    public AudioClip deathSound;
    private AudioSource audioSource;

    public delegate void DeathDelegate();
    public event DeathDelegate deathEvent;

    public delegate void WinDelegate();
    public event WinDelegate winEvent;

    public delegate void PauseDelegate();
    public event PauseDelegate pauseEvent;

    public delegate void UnPauseDelegate();
    public event UnPauseDelegate unPauseEvent;

    private bool hasDied = false;
    private bool hasWon = false;
    private bool hasPaused = false;
    private GameManager gameManager;

    public void Start() {
        audioSource = GetComponent<AudioSource>();
        gameManager = FindObjectOfType<GameManager>();
        Time.timeScale = 1f;

        GameObject playerSpawnObject = GameObject.FindGameObjectWithTag("PlayerSpawn");
        player.transform.position = playerSpawnObject.transform.position;
        GameObject.Destroy(playerSpawnObject);

        GameObject[] enemiesSpawnObjects = GameObject.FindGameObjectsWithTag("EnemySpawn");
        for (int i = 0; i < enemiesSpawnObjects.Length; i++) {
            Instantiate(enemyPrefab, enemiesSpawnObjects[i].transform.position, Quaternion.identity);
            GameObject.Destroy(enemiesSpawnObjects[i]);
        }

        GameObject goalSpawnObject = GameObject.FindGameObjectWithTag("GoalSpawn");
        goal.transform.position = goalSpawnObject.transform.position;
        GameObject.Destroy(goalSpawnObject);
    }

    public void Update() {
        if (Input.GetKeyDown(KeyCode.Escape)) {
            if (!hasDied && !hasWon) {
                if (!hasPaused) {
                    if (pauseEvent != null) {
                        pauseEvent();
                    }
                    pause.SetActive(true);
                    Time.timeScale = 0f;
                    hasPaused = true;
                } else {
                    if (unPauseEvent != null) {
                        unPauseEvent();
                    }
                    pause.SetActive(false);
                    Time.timeScale = 1f;
                    hasPaused = false;
                }
            }
        }
    }

    public void GameOver() {
        if (!hasDied) {
            if (deathEvent != null) {
                deathEvent();
            }
            gameManager.OnSceneDeath();
            audioSource.PlayOneShot(deathSound);
            gameOver.SetActive(true);
            Time.timeScale = 0f;
            hasDied = true;
        }
    }

    public void Retry() {
        gameOver.SetActive(false);
        Scene scene = SceneManager.GetActiveScene();
        StartCoroutine(LoadSceneAsync(scene.buildIndex));
    }

    public void Win() {
        if (winEvent != null) {
            winEvent();
        }
        gameManager.OnSceneWin();
        audioSource.PlayOneShot(winSound);
        win.SetActive(true);
        Time.timeScale = 0f;
    }

    public void Continue() {
        Scene scene = SceneManager.GetActiveScene();
        int index = scene.buildIndex;
        index++;
        StartCoroutine(LoadSceneAsync(index));
    }

    IEnumerator LoadSceneAsync(int sceneInt) {
        AsyncOperation asyncLoad = SceneManager.LoadSceneAsync(sceneInt, LoadSceneMode.Single);
        loadingBar.SetActive(true);
        while (!asyncLoad.isDone) {
            float progress = Mathf.Clamp01(asyncLoad.progress / 0.9f);
            loadingSlider.value = progress;
            yield return null;
        }
    }
}
