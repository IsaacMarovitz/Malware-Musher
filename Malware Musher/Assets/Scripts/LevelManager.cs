using System.Collections;
using System;
using UnityEngine;
using UnityEngine.SceneManagement;

public class LevelManager : MonoBehaviour {

    public LevelObject levels;
    public IntObject sceneToLoad;
    public GameObject player;
    public GameObject goal;
    public GameObject enemyPrefab;
    public event Action deathEvent;
    public event Action winEvent;
    public event Action pauseEvent;
    public event Action unPauseEvent;
    public event Action loadEvent;

    private int currentObjectIndex;
    private bool hasDied = false;
    private bool hasWon = false;
    private bool hasPaused = false;

    public void OnEnable() {
        SceneManager.sceneLoaded += OnSceneLoaded;
    }

    public void OnDisable() {
        SceneManager.sceneLoaded -= OnSceneLoaded;
    }

    public void Start() {
        currentObjectIndex = sceneToLoad.Value;
        if (!levels.finalLevelComplete) {
            StartCoroutine(LoadSceneAsync(levels.levelList[sceneToLoad.Value].sceneIndex, true));

        } else {
            GameFinished();
        }
    }

    public void Update() {
        if (Input.GetKeyDown(KeyCode.Escape)) {
            if (!hasDied && !hasWon) {
                if (!hasPaused) {
                    pauseEvent?.Invoke();
                    Time.timeScale = 0f;
                    hasPaused = true;
                } else {
                    unPauseEvent?.Invoke();
                    Time.timeScale = 1f;
                    hasPaused = false;
                }
            }
        }
    }

    public void UnPause() {
        unPauseEvent?.Invoke();
        Time.timeScale = 1f;
        hasPaused = false;
    }

    public void OnSceneLoaded(Scene scene, LoadSceneMode mode) {
        if (scene.name != "LevelEssentials") {
            hasWon = false;
            hasDied = false;
            Time.timeScale = 1f;

            GameObject playerSpawn = GameObject.FindGameObjectWithTag("PlayerSpawn");
            GameObject goalSpawn = GameObject.FindGameObjectWithTag("GoalSpawn");
            player.transform.position = playerSpawn.transform.position;
            goal.transform.position = goalSpawn.transform.position;
            GameObject.Destroy(playerSpawn);
            GameObject.Destroy(goalSpawn);

            GameObject[] enemiesSpawn = GameObject.FindGameObjectsWithTag("EnemySpawn");
            for (int i = 0; i < enemiesSpawn.Length; i++) {
                GameObject instantiatedEnemy = GameObject.Instantiate(enemyPrefab, enemiesSpawn[i].transform.position, Quaternion.identity);
                instantiatedEnemy.transform.parent = enemiesSpawn[i].transform;
            }

            loadEvent?.Invoke();
        }
    }

    public void GoToMainMenu() {
        StartCoroutine(LoadSceneAsync(0, false));
    }

    public void GameFinished() {
        levels.finalLevelComplete = true;
        Debug.Log("All levels have been completed");
    }

    public void OnLevelDeath() {
        deathEvent?.Invoke();
        hasDied = true;
        Time.timeScale = 0f;
    }

    public void OnLevelWin() {
        winEvent?.Invoke();
        hasWon = true;
        Time.timeScale = 0f;
    }

    public void LoadNextLevel() {
        if (!levels.finalLevelComplete) {
            levels.levelList[currentObjectIndex].level = LevelState.Completed;
            StartCoroutine(UnloadSceneAsync(levels.levelList[currentObjectIndex].sceneIndex));
            if (currentObjectIndex != levels.levelList.Count - 1) {
                currentObjectIndex++;
                levels.levelList[currentObjectIndex].level = LevelState.Unlocked;
                StartCoroutine(LoadSceneAsync(levels.levelList[currentObjectIndex].sceneIndex, true));
            } else {
                GameFinished();
            }
        }
    }

    public void ReloadLevel() {
        StartCoroutine(UnloadSceneAsync(levels.levelList[currentObjectIndex].sceneIndex));
        StartCoroutine(LoadSceneAsync(levels.levelList[currentObjectIndex].sceneIndex, true));
    }

    IEnumerator LoadSceneAsync(int sceneIndex, bool additive) {
        AsyncOperation asyncOperation;
        if (additive) {
            asyncOperation = SceneManager.LoadSceneAsync(sceneIndex, LoadSceneMode.Additive);
        } else {
            asyncOperation = SceneManager.LoadSceneAsync(sceneIndex, LoadSceneMode.Single);
        }
        while (asyncOperation.progress < 1f) {
            yield return null;
        }
    }

    IEnumerator UnloadSceneAsync(int sceneIndex) {
        AsyncOperation asyncOperation = SceneManager.UnloadSceneAsync(sceneIndex);
        while (asyncOperation.progress < 1f) {
            yield return null;
        }
    }
}