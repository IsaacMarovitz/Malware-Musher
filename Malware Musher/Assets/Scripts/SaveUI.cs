using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.IO;
using System.Runtime.Serialization.Formatters.Binary;

public class SaveUI : MonoBehaviour {

    public TMP_Text[] saveText;
    public TMP_Text menuText;
    public Button[] saveButtons;
    public GameObject saveMenu;
    public GameObject areYouSure;
    public GameObject saveQuit;
    public GameObject mainMenu;
    public GameObject quitButton;
    public GameObject normalBackButton;
    public GameObject newSaveBackButton;
    public bool isNewSave;
    public SaveManager saveManager;
    public LevelObjectClass[] levelObjects;

    private GameManager gameManager;
    private string[] filePaths = new string[3] { "save1.dat", "save2.dat", "save3.dat" };
    private bool[] fileCheck;
    private bool[] fileCompare;
    private bool undecided = true;
    private bool hasUpdatedFileList = true;
    private bool hasDisplayedSaveMenu = false;
    private bool newSave = false;
    private int fileIndex;

    // Start is called before the first frame update
    void Start() {
        saveManager = GetComponent<SaveManager>();
        gameManager = GameObject.Find("Game Manager").GetComponent<GameManager>();
        levelObjects = gameManager.levelObjects;
        fileCheck = saveManager.CheckFiles(filePaths);
    }

    // Update is called once per frame
    void Update() {
        fileCheck = saveManager.CheckFiles(filePaths);
        if (fileCheck != fileCompare) {
            hasUpdatedFileList = false;
            fileCompare = fileCheck;
        }
        if (saveMenu.activeSelf && !hasUpdatedFileList) {
            for (int i = 0; i < fileCheck.Length; i++) {
                if (fileCheck[i]) {
                    saveText[i].text = saveManager.Load(filePaths[i]).saveTime;
                } else {
                    saveText[i].text = "No save";
                }
            }
            hasUpdatedFileList = true;
        }
    }

    public void Save(int index) {
        if (fileCheck[index] && undecided) {
            fileIndex = index;
            areYouSure.SetActive(true);
            saveMenu.SetActive(false);
        } else {
            saveManager.Save(levelObjects, filePaths[index]);
            saveMenu.SetActive(false);
            if (!newSave) {
                saveQuit.SetActive(true);
            } else {
                GetComponent<LoadUI>().Load(index);
            }
            undecided = true;
        }
    }

    public void NewSave() {
        menuText.text = "Make a New Save";
        saveMenu.SetActive(true);
        quitButton.SetActive(false);
        normalBackButton.SetActive(false);
        newSaveBackButton.SetActive(true);
        newSave = true;
    }

    public void DisplaySaveMenu() {
        if (!hasDisplayedSaveMenu) {
            saveMenu.SetActive(true);
            mainMenu.SetActive(false);
            hasDisplayedSaveMenu = true;
        }
    }

    public void ForceQuit() {
        gameManager.ForceQuit();
    }

    public void Yes() {
        undecided = false;
        saveMenu.SetActive(true);
        Save(fileIndex);
    }

    public void No() {
        undecided = false;
        saveMenu.SetActive(false);
    }
}
