using System;
using System.Collections;
using UnityEngine;
using UnityEngine.SceneManagement;

public class GameManager : MonoBehaviour {

    public static GameManager Instance { get; private set; }
    public LevelData[] levelDataArray;

    public delegate void SceneLoadedDelegate();
    public event SceneLoadedDelegate sceneEvent;

    private int currentLevelIndex;

    private void Awake() {
        if (Instance == null) {
            Instance = this;
            DontDestroyOnLoad(gameObject);
        } else {
            Destroy(gameObject);
        }
    }

    void OnEnable() {
        SceneManager.sceneLoaded += OnSceneLoaded;
    }

    void OnSceneLoaded(Scene scene, LoadSceneMode mode) {
        if (scene.name != "LevelEssentials") {
            int currentSceneIndex = SceneManager.GetActiveScene().buildIndex;
            for (int i = 0; i < levelDataArray.Length; i++) {
                if (levelDataArray[i].sceneIndex == currentSceneIndex) {
                    currentLevelIndex = i;
                    break;
                }
            }
        }
    }

    public void CallSceneEvent() {
        if (sceneEvent != null) 
            sceneEvent();
    }

    public void BeginGame(LevelData levelData) {
        StartCoroutine(LoadLevelEssentials("LevelEssentials"));
        StartCoroutine(LoadLevel(levelData.sceneIndex, CallSceneEvent));
        for (int i = 0; i < levelDataArray.Length; i++) {
            if (levelDataArray[i] == levelData) {
                currentLevelIndex = i;
            }
        }
    }

    public void OnSceneWin() {
        levelDataArray[currentLevelIndex].hasBeenCompleted = true;
        levelDataArray[currentLevelIndex + 1].hasBeenUnlocked = true;
        StartCoroutine(UnloadSceneAsyncInt(levelDataArray[currentLevelIndex].sceneIndex));
        if (currentLevelIndex != levelDataArray.Length - 1) {
            currentLevelIndex++;
            StartCoroutine(LoadLevel(levelDataArray[currentLevelIndex].sceneIndex, CallSceneEvent));
        } else {
            // Game Finished
        }
    }

    public void OnSceneDeath() {
        StartCoroutine(UnloadSceneAsyncInt(levelDataArray[currentLevelIndex].sceneIndex));
        StartCoroutine(LoadLevel(levelDataArray[currentLevelIndex].sceneIndex, CallSceneEvent));
    }

    #region SceneManagement
    IEnumerator LoadLevel(int sceneIndex, Action onCallback) {
        AsyncOperation asyncLoad = SceneManager.LoadSceneAsync(sceneIndex, LoadSceneMode.Additive);
        while (!asyncLoad.isDone) {
            yield return null;
            onCallback();
        }
    }

    IEnumerator LoadLevelEssentials(string LevelEssentialsName) {
        AsyncOperation asyncLoad = SceneManager.LoadSceneAsync(LevelEssentialsName, LoadSceneMode.Single);
        while (!asyncLoad.isDone) {
            yield return null;
        }
    }

    IEnumerator UnloadSceneAsyncInt(int sceneIndex) {
        AsyncOperation asyncUnload = SceneManager.UnloadSceneAsync(sceneIndex);
        while (!asyncUnload.isDone) {
            yield return null;
        }
    }
    #endregion
}
