using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.SceneManagement;

public class GameManager : MonoBehaviour {

    public static GameManager Instance { get; private set; }

    public LevelObjectClass[] levelObjects;
    public GameObject levelObejectPrefab;
    public Vector3 spawnPosition;
    public float xOffset;

    private Manager manager;
    private int currentSceneIndex;
    private int levelObjectsIndex;
    private LevelObjectClass levelObject;
    private bool sceneLevelObjectsHasBeenSet;
    private bool showSaveMenu = false;
    private GameObject[] menuLevelObjects;
    private Vector3 offsetSpawnPosition;

    private void Awake() {
        if (Instance == null) {
            Instance = this;
            DontDestroyOnLoad(gameObject);
        } else {
            Destroy(gameObject);
        }
    }

    void OnEnable() {
        SceneManager.sceneLoaded += OnSceneLoaded;
    }

    void OnSceneLoaded(Scene scene, LoadSceneMode mode) {
        Time.timeScale = 1f;
        sceneLevelObjectsHasBeenSet = false;
        manager = FindObjectOfType<Manager>();
        if (manager != null) {
            FindObjectOfType<Manager>().winEvent += OnSceneWin;
            FindObjectOfType<Manager>().deathEvent += OnSceneDeath;
        }
        currentSceneIndex = SceneManager.GetActiveScene().buildIndex;
        for (int i = 0; i < levelObjects.Length; i++) {
            if (levelObjects[i].sceneIndex == currentSceneIndex) {
                levelObject = levelObjects[i];
                levelObjectsIndex = i;
                break;
            }
        }
    }

    void OnSceneWin() {
        FindObjectOfType<Manager>().winEvent -= OnSceneWin;
        FindObjectOfType<Manager>().deathEvent -= OnSceneDeath;
        levelObjects[levelObjectsIndex].hasBeenCompleted = true;
        if (levelObjectsIndex < levelObjects.Length - 1) {
            levelObjects[levelObjectsIndex + 1].hasBeenUnlocked = true;
        }
    }

    void OnSceneDeath() {
        FindObjectOfType<Manager>().winEvent -= OnSceneWin;
        FindObjectOfType<Manager>().deathEvent -= OnSceneDeath;
    }

    void Update() {
        if (SceneManager.GetActiveScene().name == "Menu" && showSaveMenu) {
            GameObject.FindGameObjectWithTag("IO").GetComponent<SaveUI>().DisplaySaveMenu();
        }
        if (SceneManager.GetActiveScene().name == "Menu" && !sceneLevelObjectsHasBeenSet) {
            menuLevelObjects = new GameObject[levelObjects.Length];
            offsetSpawnPosition = spawnPosition;
            for (int i = 0; i < levelObjects.Length; i++) {
                menuLevelObjects[i] = Instantiate(levelObejectPrefab, offsetSpawnPosition, Quaternion.identity);
                menuLevelObjects[i].name = levelObjects[i].sceneName;
                menuLevelObjects[i].GetComponent<LevelObject>().levelObject = levelObjects[i];
                offsetSpawnPosition.x += xOffset;
            }
            sceneLevelObjectsHasBeenSet = true;
        } else if (SceneManager.GetActiveScene().name == "Menu" && sceneLevelObjectsHasBeenSet) {
            for (int i = 0; i < levelObjects.Length; i++) {
                menuLevelObjects[i].name = levelObjects[i].sceneName;
                menuLevelObjects[i].GetComponent<LevelObject>().levelObject = levelObjects[i];
            }
        }
    }

    public void GoToMainMenu() {
        StartCoroutine(LoadSceneAsync(0));
        showSaveMenu = true;
    }

    public void ForceQuit() {
        Application.Quit();
    }

    public void Quit() {
        GoToMainMenu();

    }

    IEnumerator LoadSceneAsync(int sceneInt) {
        AsyncOperation asyncLoad = SceneManager.LoadSceneAsync(sceneInt, LoadSceneMode.Single);
        while (!asyncLoad.isDone) {
            float progress = Mathf.Clamp01(asyncLoad.progress / 0.9f);
            yield return null;
        }
    }
}
