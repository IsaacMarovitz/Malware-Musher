using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.UI;
using UnityEngine.Events;
using TMPro;

public class Manager : MonoBehaviour {

    [Header("GameObjects")]
    public GameObject gameOver;
    public GameObject menu;
    public GameObject loadingBar;
    public GameObject win;
    public GameObject pause;
    public GameObject hud;
    [Header("UI Elements")]
    public Slider slider;
    public TMP_Text gunCooldown;
    public TMP_Text laserCooldown;
    public TMP_Text playerHealth;
    [Header("Scripts")]
    public Gun gun;
    public Laser laser;
    public PlayerHealth playerHealthScript;
    [Header("Audio")]
    private AudioSource audioSource;
    public AudioClip winSound;
    public AudioClip deathSound;

    public delegate void DeathDelegate();
    public event DeathDelegate deathEvent;

    public delegate void WinDelegate();
    public event WinDelegate winEvent;

    public delegate void PauseDelegate();
    public event PauseDelegate pauseEvent;

    public delegate void UnPauseDelegate();
    public event UnPauseDelegate unPauseEvent;

    private bool hasDied = false;
    private bool hasWon = false;
    private bool hasPaused = false;

    public void Start() {
        audioSource = GetComponent<AudioSource>();
        Time.timeScale = 1f;
    }

    public void Update() {
        if (SceneManager.GetActiveScene().name != "Game End") {
            if (gun.timeLeft < gun.cooldownTime) {
                gunCooldown.text = "Gun: " + (Mathf.Round(gun.timeLeft * 100)) / 100;
            } else {
                gunCooldown.text = "Gun: Ready!";
            }
            if (laser.timeLeft < laser.cooldownTime) {
                laserCooldown.text = "Laser: " + (Mathf.Round(laser.timeLeft * 100)) / 100;
            } else {
                laserCooldown.text = "Laser: Ready!";
            }
            playerHealth.text = "Health: " + playerHealthScript.health;
            if (Input.GetKeyDown(KeyCode.Escape)) {
                if (!hasDied && !hasWon) {
                    if (!hasPaused) {
                        if (pauseEvent != null) {
                            pauseEvent();
                        }
                        hud.SetActive(false);
                        pause.SetActive(true);
                        gun.cooldownComplete = false;
                        laser.cooldownComplete = false;
                        Time.timeScale = 0f;
                        hasPaused = true;
                    } else {
                        if (unPauseEvent != null) {
                            unPauseEvent();
                        }
                        hud.SetActive(true);
                        pause.SetActive(false);
                        Time.timeScale = 1f;
                        hasPaused = false;
                    }
                }
            }
        }
    }

    public void GameOver() {
        if (!hasDied) {
            if (deathEvent != null) {
                deathEvent();
            }
            audioSource.PlayOneShot(deathSound);
            gun.cooldownComplete = false;
            laser.cooldownComplete = false;
            hud.SetActive(false);
            gameOver.SetActive(true);
            Time.timeScale = 0f;
            hasDied = true;
        }
    }

    public void Retry() {
        gameOver.SetActive(false);
        Scene scene = SceneManager.GetActiveScene();
        StartCoroutine(LoadSceneAsync(scene.buildIndex));
    }

    public void Win() {
        if (winEvent != null) {
            winEvent();
        }
        audioSource.PlayOneShot(winSound);
        gun.cooldownComplete = false;
        laser.cooldownComplete = false;
        hud.SetActive(false);
        win.SetActive(true);
        Time.timeScale = 0f;
    }

    public void Continue() {
        Scene scene = SceneManager.GetActiveScene();
        int index = scene.buildIndex;
        index++;
        StartCoroutine(LoadSceneAsync(index));
    }

    public void GoToMainMenu(bool showMenu) {
        GameObject.Find("Game Manager").GetComponent<GameManager>().GoToMainMenu(showMenu);
    }

    public void Quit() {
        GameObject.Find("Game Manager").GetComponent<GameManager>().Quit();
    }

    IEnumerator LoadSceneAsync(int sceneInt) {
        AsyncOperation asyncLoad = SceneManager.LoadSceneAsync(sceneInt, LoadSceneMode.Single);
        menu.SetActive(false);
        loadingBar.SetActive(true);
        while (!asyncLoad.isDone) {
            float progress = Mathf.Clamp01(asyncLoad.progress / 0.9f);
            slider.value = progress;
            yield return null;
        }
    }
}
