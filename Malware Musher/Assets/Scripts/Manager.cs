using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.UI;
using TMPro;

public class Manager : MonoBehaviour {

    [Header("GameObjects")]
    public GameObject gameOver;
    public GameObject menu;
    public GameObject loadingBar;
    public GameObject win;
    [Header("UI Elements")]
    public Slider slider;
    public TMP_Text gunCooldown;
    public TMP_Text laserCooldown;
    public TMP_Text playerHealth;
    [Header("Scripts")]
    public Gun gun;
    public Laser laser;
    public PlayerHealth playerHealthScript;
    [Header("Audio")]
    private AudioSource audioSource;
    public AudioClip winSound;
    public AudioClip deathSound;

    private bool hasDied = false;

    public void Start() {
        audioSource = GetComponent<AudioSource>();
        Time.timeScale = 1f;
    }

    public void Update() {
        if (gun.timeLeft < gun.cooldownTime) {
            gunCooldown.text = "Gun: " + (Mathf.Round(gun.timeLeft * 100)) / 100;
        } else {
            gunCooldown.text = "Gun: Ready!";
        }
        if (laser.timeLeft < laser.cooldownTime) {
            laserCooldown.text = "Laser: " + (Mathf.Round(laser.timeLeft * 100)) / 100;
        } else {
            laserCooldown.text = "Laser: Ready!";
        }
        playerHealth.text = "Health: " + playerHealthScript.health;
    }

    public void GameOver() {
        if (!hasDied) {
            audioSource.PlayOneShot(deathSound);
            gun.cooldownComplete = false;
            laser.cooldownComplete = false;
            gameOver.SetActive(true);
            Time.timeScale = 0f;
            hasDied = true;
        }
    }

    public void Retry() {
        gameOver.SetActive(false);
        Scene scene = SceneManager.GetActiveScene();
        StartCoroutine(LoadSceneAsync(scene.buildIndex));
    }

    public void Win() {
        audioSource.PlayOneShot(winSound);
        gun.cooldownComplete = false;
        laser.cooldownComplete = false;
        win.SetActive(true);
        Time.timeScale = 0f;
    }

    public void Continue()  {
        Scene scene = SceneManager.GetActiveScene();
        int index = scene.buildIndex;
        index++;
        StartCoroutine(LoadSceneAsync(index));
    }

    IEnumerator LoadSceneAsync(int sceneInt) {
        AsyncOperation asyncLoad = SceneManager.LoadSceneAsync(sceneInt);
        menu.SetActive(false);
        loadingBar.SetActive(true);
        while (!asyncLoad.isDone) {
            float progress = Mathf.Clamp01(asyncLoad.progress / 0.9f);
            slider.value = progress;
            yield return null;
        }
    }
}
