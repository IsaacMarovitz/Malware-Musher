using System;
using UnityEngine;

public class PlayerHealth : MonoBehaviour {

    public int maxHealth = 100;
    public int health;
    public AudioClip damageSound;
    public AudioClip deathSound;
    public event Action<int> damageEvent;
    [HideInInspector]
    public HealthObject healthObject;

    private LevelManager levelManager;
    private AudioSource audioSource;
    private bool hasDied = false;

    void Start() {
        levelManager = FindObjectOfType<LevelManager>();
        levelManager.loadEvent += OnLoad;
        health = maxHealth;
        audioSource = GetComponent<AudioSource>();
    }

    void Update() {
        if (transform.position.y <= -100) {
            Die();
        }
        if (healthObject != null) {
            healthObject.Initialise(gameObject);
            healthObject = null;
        }
    }

    public void OnDisable() {
        levelManager.loadEvent -= OnLoad;
    }

    public void OnLoad() {
        hasDied = false;
        health = maxHealth;
        audioSource.Stop();
    }

    public void TakeDamage(int damage) {
        damageEvent?.Invoke(damage);
        health -= damage;
        if (health <= 0) {
            Die();
        } else {
            audioSource.PlayOneShot(damageSound);
        }
    }

    public void GainHealth(int healthIncrease) {
        health += healthIncrease;
        if (health > maxHealth) {
            health = maxHealth;
        }
    }

    public void Die() {
        if (!hasDied) {
            audioSource.PlayOneShot(deathSound);
            levelManager.OnLevelDeath();
            hasDied = true;
        }
    }
}
