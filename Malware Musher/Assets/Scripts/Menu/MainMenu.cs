using System.Collections;
using System.IO;
using System.Runtime.Serialization.Formatters.Binary;
using UnityEngine;
using UnityEngine.SceneManagement;

public class MainMenu : MonoBehaviour {
    
    public string saveDirectoryName;
    public string saveFileName;
    public int levelEssentialsIndex;
    public LevelObject levels;
    public IntObject levelToLoadIndex;
    public GameObject levelSelectMenu;
    public GameObject mainMenu;
    public GameObject levelSelectButtonPrefab;
    public Transform buttonHolder;

    private SaveData saveData;
    private string saveDataPath;

    public void OnEnable() {
        saveDataPath = Application.persistentDataPath + "/" + saveDirectoryName;
    }

    public void StartMenu() {
        mainMenu.SetActive(false);
        levelSelectMenu.SetActive(true);
        for (int i = 0; i < levels.levelList.Count; i++) {
            GameObject instantiatedUI = GameObject.Instantiate(levelSelectButtonPrefab, Vector3.zero, Quaternion.identity);
            bool interactable;
            if (levels.levelList[i].level == LevelState.Locked) {
                interactable = false;
            } else {
                interactable = true;
            }
            instantiatedUI.GetComponent<LevelSelectButton>().SetValue(i, this, interactable);
            instantiatedUI.transform.SetParent(buttonHolder);
        }
    }

    public void LoadLevel(int levelIndex) {
        levelToLoadIndex.Value = levelIndex;
        StartCoroutine(LoadSceneAsync());
    }

    public void Continue() {
        for (int i = 0; i < levels.levelList.Count; i++) {
            if (levels.levelList[i].level == LevelState.Completed) {
                if (i != levels.levelList.Count - 1) {
                    if (levels.levelList[i + 1].level != LevelState.Completed) {
                        levels.levelList[i + 1].level = LevelState.Unlocked;
                    }
                } else {
                    levels.finalLevelComplete = true;
                }
            } else if (levels.levelList[i].level == LevelState.Unlocked) {
                levelToLoadIndex.Value = i;
            }
        }
        if (!levels.finalLevelComplete) {
            if (levelToLoadIndex.Value == -1) {
                levelToLoadIndex.Value = 0;
                levels.levelList[0].level = LevelState.Unlocked;
            }
        }
        StartCoroutine(LoadSceneAsync());
    }

    public void NewGame() {
        for (int i = 0; i < levels.levelList.Count; i++) {
            levels.levelList[i].level = LevelState.Locked;
        }
        levels.levelList[0].level = LevelState.Unlocked;
        levelToLoadIndex.Value = 0;
        levels.finalLevelComplete = false;
        SaveGame();
    }

    public void SaveGame() {
        if (!IsSaveFile()) {
            Directory.CreateDirectory(saveDataPath);
        }
        BinaryFormatter bf = new BinaryFormatter();
        FileStream file = File.Create(saveDataPath + "/" + saveFileName);
        saveData = ConvertLevelSOToSaveData(levels);
        bf.Serialize(file, saveData);
        file.Close();
    }

    public void LoadGame() {
        if (!Directory.Exists(saveDataPath)) {
            Directory.CreateDirectory(saveDataPath);
        }
        BinaryFormatter bf = new BinaryFormatter();
        if (File.Exists(saveDataPath + "/" + saveFileName)) {
            FileStream file = File.Open(saveDataPath + "/" + saveFileName, FileMode.Open);
            LevelObject loadedData = ConvertSaveDataToLevelSO((SaveData)bf.Deserialize(file));
            levels.levelList = loadedData.levelList;
            levels.finalLevelComplete = loadedData.finalLevelComplete;
            file.Close();
        }
    }

    public bool IsSaveFile() {
        return Directory.Exists(saveDataPath);
    }

    public SaveData ConvertLevelSOToSaveData(LevelObject levelObject) {
        return new SaveData(levelObject.levelList, levelObject.finalLevelComplete);
    }

    public LevelObject ConvertSaveDataToLevelSO(SaveData saveData) {
        LevelObject returnObject = ScriptableObject.CreateInstance<LevelObject>();
        returnObject.levelList = saveData.levelList;
        returnObject.finalLevelComplete = saveData.finalLevelComplete;
        return returnObject;
    }

    IEnumerator LoadSceneAsync() {
        AsyncOperation asyncOperation = SceneManager.LoadSceneAsync(levelEssentialsIndex, LoadSceneMode.Single);
        while (asyncOperation.progress < 1f) {
            yield return null;
        }
    }
}