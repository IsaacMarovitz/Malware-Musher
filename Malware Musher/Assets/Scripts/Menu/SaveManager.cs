using System.Collections;
using System.IO;
using System.Runtime.Serialization.Formatters.Binary;
using UnityEngine;
using UnityEngine.SceneManagement;

public class SaveManager : MonoBehaviour {

    public string saveDirectoryName;
    public string saveFileNamePrefix;
    public string saveFileNameSuffix;
    public int levelEssentialsIndex;
    public LevelObject levels;
    public IntObject levelToLoadIndex;

    private SaveData saveData;
    private string saveDataPath;
    private float asyncOperationProgress;

    public void Start() {
        saveDataPath = Application.persistentDataPath + "/" + saveDirectoryName; 
    }

    public void Continue() {
        for (int i = 0; i < levels.levelList.Count; i++) {
            if (levels.levelList[i].level == LevelState.Completed) {
                if (i != levels.levelList.Count - 1) {
                    if (levels.levelList[i + 1].level != LevelState.Completed) {
                        levels.levelList[i + 1].level = LevelState.Unlocked;
                    }
                } else {
                    levels.finalLevelComplete = true;
                }
            } else if (levels.levelList[i].level == LevelState.Unlocked) {
                levelToLoadIndex.Value = i;
            }
        }
        if (!levels.finalLevelComplete) {
            if (levelToLoadIndex.Value == -1) {
                levelToLoadIndex.Value = 0;
                levels.levelList[0].level = LevelState.Unlocked;
            }
        }
        StartCoroutine(LoadSceneAsync());
    }

    public void LoadLevel(int levelIndex) {
        levelToLoadIndex.Value = levelIndex;
        StartCoroutine(LoadSceneAsync());
    }

    public void SaveGame(int save) {
        string saveFileName = saveFileNamePrefix + save + saveFileNameSuffix;

        if (!SaveDirectoryExists()) {
            Directory.CreateDirectory(saveDataPath);
        }
        BinaryFormatter bf = new BinaryFormatter();
        FileStream file = File.Create(saveDataPath + "/" + saveFileName);
        saveData = ConvertLevelSOToSaveData(levels);
        bf.Serialize(file, saveData);
        file.Close();
    }

    public void NewGame() {
        foreach (var level in levels.levelList) {
            level.level = LevelState.Locked;
        }
        levels.levelList[0].level = LevelState.Unlocked;
        levels.finalLevelComplete = false;
        LoadLevel(0);
    }

    public LevelObject LoadGameData(int save) {
        string saveFileName = saveFileNamePrefix + save + saveFileNameSuffix;

        if (!SaveDirectoryExists()) {
            Directory.CreateDirectory(saveDataPath);
        }

        BinaryFormatter bf = new BinaryFormatter();
        if (File.Exists(saveDataPath + "/" + saveFileName)) {
            FileStream file = File.Open(saveDataPath + "/" + saveFileName, FileMode.Open);
            LevelObject loadedData = ConvertSaveDataToLevelSO((SaveData)bf.Deserialize(file));
            levels.levelList = loadedData.levelList;
            levels.finalLevelComplete = loadedData.finalLevelComplete;
            file.Close();
        } else {
            foreach (var level in levels.levelList) {
                level.level = LevelState.Locked;
            }
            levels.levelList[0].level = LevelState.Unlocked;
            levels.finalLevelComplete = false;
        }
        return levels;
    }

    public float GetAsyncOperationProgress() {
        return asyncOperationProgress;
    }

    public bool SaveDirectoryExists() {
        return Directory.Exists(saveDataPath);
    }

    public bool SaveFileExists(int save) {
        if (File.Exists(saveDataPath + "/" + saveFileNamePrefix + save + saveFileNameSuffix)) {
            return true;
        } else {
            return false;
        }
    }

    public bool SaveFilesExist() {
        if (File.Exists(saveDataPath + "/" + saveFileNamePrefix + 1 + saveFileNameSuffix)) {
            return true;
        } else if (File.Exists(saveDataPath + "/" + saveFileNamePrefix + 2 + saveFileNameSuffix)) {
            return true;
        } else if (File.Exists(saveDataPath + "/" + saveFileNamePrefix + 3 + saveFileNameSuffix)) {
            return true;
        } else {
            return false;
        }
    }

    public SaveData ConvertLevelSOToSaveData(LevelObject levelObject) {
        return new SaveData(levelObject.levelList, levelObject.finalLevelComplete);
    }

    public LevelObject ConvertSaveDataToLevelSO(SaveData saveData) {
        LevelObject returnObject = ScriptableObject.CreateInstance<LevelObject>();
        returnObject.levelList = saveData.levelList;
        returnObject.finalLevelComplete = saveData.finalLevelComplete;
        return returnObject;
    }

    IEnumerator LoadSceneAsync() {
        AsyncOperation asyncOperation = SceneManager.LoadSceneAsync(levelEssentialsIndex, LoadSceneMode.Single);
        while (asyncOperation.progress < 1f) {
            asyncOperationProgress = asyncOperation.progress;
            yield return null;
        }
    }
}