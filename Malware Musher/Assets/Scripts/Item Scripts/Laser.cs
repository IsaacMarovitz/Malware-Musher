using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class Laser : MonoBehaviour {

    public LayerMask layerMask;
    public LineRenderer lineRenderer;
    public float lineSpeed;
    public Color start;
    public Color end;

    private Vector3 shootDirection;
    private Vector3 lineDirection = new Vector3(0, 0, 0);
    private Vector3 lerpedLineDirection;
    private float distance;
    private float startLerpTime;
    public float laserLengthTimeDelay;
    public Vector3 laserTransform = new Vector3(0, 0, 0);
    private bool laserLengthTimeDelayFinished = false;

    private Vector3 startLerpedLine;
    private float startStartLerpTime;
    private Vector3 startTransformPosition;

    public float cooldownTime;
    public float timeLeft;
    public bool cooldownComplete = true;
    public float startTime;
    public int damageDelt;
    public AudioClip laserSound;

    private AudioSource audioSource;
    private bool canShoot;
    private bool hasShot = false;

    void Start() {
        audioSource = GetComponent<AudioSource>();
        lineRenderer = GetComponent<LineRenderer>();
        lineRenderer.startWidth = 0.05f;
        lineRenderer.endWidth = 0.05f;
        lineRenderer.startColor = start;
        lineRenderer.endColor = end;
        timeLeft = cooldownTime;
        canShoot = true;
    }

    public void Update() {
        if (canShoot) {
            if (Input.GetButtonDown("Fire2")) {
                Shoot();
                hasShot = true;
            }
        }
        if (hasShot) {
            if (!cooldownComplete) {
                timeLeft = Time.time - startTime;
            }

            float duration = (Time.time - startLerpTime) * lineSpeed;
            float lerpFraction = duration / distance;
            lerpedLineDirection = Vector3.Lerp(laserTransform, lineDirection, lerpFraction);
            lineRenderer.SetPosition(1, lerpedLineDirection);

            if (laserLengthTimeDelayFinished) {
                float startDuration = (Time.time - startStartLerpTime) * lineSpeed;
                float startLerpFraction = startDuration / distance;
                startLerpedLine = Vector3.Lerp(laserTransform, lineDirection, startLerpFraction);
                lineRenderer.SetPosition(0, startLerpedLine);
            }
        }
    }

    public void FreezeShoot() {
        canShoot = false;
    }

    public void UnFreezeShoot() {
        canShoot = true;
    }

    public void Shoot() {
        if (cooldownComplete) {
            audioSource.PlayOneShot(laserSound);
            laserTransform = transform.position;
            laserTransform.z = 0;
            shootDirection = Input.mousePosition;
            shootDirection.z = 0;
            shootDirection = Camera.main.ScreenToWorldPoint(shootDirection);
            shootDirection = shootDirection - laserTransform;
            RaycastHit2D info = Physics2D.Raycast(laserTransform, shootDirection, Mathf.Infinity, layerMask);
            // Debug.DrawRay(laserTransform, shootDirection, Color.black, 2f);
            lineRenderer.SetPosition(0, laserTransform);
            if (info.collider != null && info.collider.isTrigger == false) {
                lineDirection = info.point;
            } else {
                lineDirection = shootDirection * 10;
                lineDirection.z = 0;
            }
            distance = Vector3.Distance(laserTransform, lineDirection);
            startLerpTime = Time.time;
            if (info && info.transform.tag == "Enemy") {
                info.transform.GetComponent<EnemyHealth>().TakeDamage(damageDelt);
            }
            cooldownComplete = false;
            laserLengthTimeDelayFinished = false;
            startTime = Time.time;
            StartCoroutine(Cooldown());
            StartCoroutine(LaserLengthDelay());
        }
    }

    public IEnumerator Cooldown() {
        yield return new WaitForSeconds(cooldownTime);
        cooldownComplete = true;
    }

    public IEnumerator LaserLengthDelay() {
        yield return new WaitForSeconds(laserLengthTimeDelay);
        laserLengthTimeDelayFinished = true;
        startStartLerpTime = Time.time;
    }
}
