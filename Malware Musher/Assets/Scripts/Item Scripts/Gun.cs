using UnityEngine;

public class Gun : MonoBehaviour {

    public GameObject bulletPrefab;
    public Vector3 firePoint;
    public Quaternion firePointRotation;

    public float cooldownTime;
    public float timeLeft;
    public bool cooldownComplete = true;
    public float startTime;
    public int damageDelt;
    public AudioClip gunSound;

    private AudioSource audioSource;
    private LevelManager levelManager;
    private bool canShoot;
    private float angle;

    void Start() {
        audioSource = GetComponent<AudioSource>();
        levelManager = FindObjectOfType<LevelManager>();
        levelManager.deathEvent += FreezeShoot;
        levelManager.winEvent += FreezeShoot;
        levelManager.pauseEvent += FreezeShoot;
        levelManager.unPauseEvent += UnFreezeShoot;
        timeLeft = cooldownTime;
        canShoot = true;
        firePoint = this.gameObject.transform.position;
        firePointRotation = Quaternion.identity;
    }

    public void Update() {
        var dir = Input.mousePosition - Camera.main.WorldToScreenPoint(transform.position);
        angle = Mathf.Atan2(dir.y, dir.x) * Mathf.Rad2Deg;
        firePoint = this.gameObject.transform.position;
        if (angle < 90 && angle > -90) {
            firePoint += new Vector3(0.5f, 0f, 0f);
            firePointRotation.eulerAngles = new Vector3(0f, 0f, 0f);
        } else {
            firePoint += new Vector3(-0.5f, 0f, 0f);
            firePointRotation.eulerAngles = new Vector3(0f, 180f, 0f);
        }
        if (canShoot) {
            if (Input.GetButtonDown("Fire1")) {
                Shoot();
            }
        }
        if (!cooldownComplete) {
            timeLeft = Time.time - startTime;
            if (timeLeft >= cooldownTime) {
                cooldownComplete = true;
            }
        }
    }

    public void FreezeShoot() {
        canShoot = false;
    }

    public void UnFreezeShoot() {
        canShoot = true;
    }

    public void Shoot() {
        if (cooldownComplete) {
            audioSource.PlayOneShot(gunSound);
            GameObject bullet = Instantiate(bulletPrefab, firePoint, firePointRotation);
            bullet.GetComponent<Bullet>().FromPlayer();
            bullet.GetComponent<Bullet>().damageDelt = damageDelt;
            cooldownComplete = false;
            startTime = Time.time;
        }
    }
}
